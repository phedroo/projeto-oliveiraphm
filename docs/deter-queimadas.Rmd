
## Deter - Queimadas e desmatamento

```{r, eval=FALSE}
library(tidyverse)
library(sf) # ler shapefile
```

```{r, eval=FALSE}
# Exemplo com os trÃªs shapefiles que vocÃª mostrou
amz <- st_read("../data-raw/deter/deter-amz-deter-public.shp") # ALB (completo, desde 2016)

cerrado <- st_read("../data-raw/deter/deter-cerrado-nb-deter-public.shp") # Somente desmatamento

pantanal <- st_read("../data-raw/deter/deter-pantanal-deter-public.shp") # Dados de cicatriz de queimada Somente a partir de 2023
```


```{r, eval=FALSE}
# EXEMPLIFICANDO COM AMAZONIA
# Ver estrutura
# str(amz)
# 
# # Visualizar os primeiros registros
# head(amz) 
#   # ou
#   glimpse(amz)
# 
# # Visualizar nomes das colunas
# names(amz) #Coluna de interesse ("CLASSNAME")
# 
# # Visualizar nomes das linhas da coluna "CLASSNAME"
# amz$CLASSNAME
# 
# # Quantificar observaÃ§Ãµes
# table(amz$CLASSNAME)
# 
#   # Verificar valores Ãºnicos de classe e estado
#   unique(amz$CLASSNAME) # Linha de interesse ("CICATRIZ_DE_QUEIMADA")
#   unique(amz$UF) # Somente MT
#   


# Filtrar para linha de interesse
amz <- amz |>
    # select(CLASSNAME, VIEW_DATE, UF, geometry, MUNICIPALI)
    mutate(
      bioma = "AmazÃ´nia"
    ) |> 
    filter(CLASSNAME == "CICATRIZ_DE_QUEIMADA",
           UF == "MT")


# Plot simples
# plot(st_geometry(amz))


ggplot(amz) +
  geom_sf() +  # Preenchimento por bioma, sem contorno
  # scale_fill_manual(values = c("AmazÃ´nia" = "#1b9e77", 
  #                              "Cerrado" = "#d95f02", 
  #                              "Pantanal" = "#7570b3")) +
  theme_minimal() +
  labs(title = "Queimada AmazÃ´nia Legal brasileira (DETER)") +
  theme(legend.position = "bottom")
```

```{r, eval=FALSE}
# str(cerrado)
glimpse(cerrado)
unique(cerrado$UF)

cerrado <- cerrado |> 
  mutate(
    bioma = "Cerrado"
  ) |> 
  filter(CLASSNAME == "DESMATAMENTO_CR", # SÃ³ desmat
                     UF == c("MT", "MS", "GO", "DF"))

ggplot(cerrado) +
  geom_sf() +  # Preenchimento por bioma, sem contorno
  # scale_fill_manual(values = c("AmazÃ´nia" = "#1b9e77", 
  #                              "Cerrado" = "#d95f02", 
  #                              "Pantanal" = "#7570b3")) +
  theme_minimal() +
  labs(title = "Desmatamento Cerrado (DETER)") +
  theme(legend.position = "bottom")
```

```{r, eval = FALSE}
# str(pantanal)
glimpse(pantanal)
unique(pantanal$CLASS_NAME)

pantanal <- pantanal |> 
  mutate(CLASSNAME = CLASS_NAME,
         bioma = "Pantanal") |> # padronizar nome da coluna
  filter(CLASSNAME == "cicatriz de queimada")

ggplot(pantanal) +
  geom_sf() +  # Preenchimento por bioma, sem contorno
  # scale_fill_manual(values = c("AmazÃ´nia" = "#1b9e77", 
  #                              "Cerrado" = "#d95f02", 
  #                              "Pantanal" = "#7570b3")) +
  theme_minimal() +
  labs(title = "Queimada Pantanal (DETER)") +
  theme(legend.position = "bottom")
```

```{r, eval=FALSE}
# Unindo shapefiles em um Ãºnico
deter_all <- bind_rows(amz, cerrado, pantanal)

# Gerando plot dos biomas 
ggplot(deter_all) +
  geom_sf(aes(fill = bioma), color = NA) +
  scale_fill_manual(values = c(
    "AmazÃ´nia" = "#1b9e77",
    "Cerrado" = "#d95f02",
    "Pantanal" = "#7570b3"
  )) +
  theme_minimal() +
  labs(title = "Ãreas com Cicatriz de Queimada e Desmatamento (DETER)",
       fill = "Bioma") +
  theme(legend.position = "bottom")

# Baixando arquivo shapefile unido
# write_rds(deter_all, "areas-queimada-biomas")
deter_all$geometry[[1]] |> plot()
deter_all |> 
  mutate(ANO = year(VIEW_DATE)) |> 
  filter(ANO == 2021) |> 
  ggplot() +
  geom_sf(aes(fill = bioma), color = NA) +
  scale_fill_manual(values = c(
    "AmazÃ´nia" = "#1b9e77",
    "Cerrado" = "#d95f02",
    "Pantanal" = "#7570b3"
  )) +
  theme_minimal() +
  labs(title = "Ãreas com Cicatriz de Queimada e Desmatamento (DETER)",
       fill = "Bioma") +
  theme(legend.position = "bottom") 
```

```{r, eval=FALSE}
# AveriguaÃ§Ã£o do CÃ¡lculo da Ãrea
# pantanal |> slice(1) |> pull(geometry) |> plot()# 0.1000308
# coords <- pantanal$geometry[[1]] |> as.matrix()
# geosphere::areaPolygon(coords) / 1000000

func_ret_x <-function(geometria){
  ob <- geometria[[1]] |> as.matrix()
  mean(ob[,1])
}

func_ret_y <-function(geometria){
  ob <- geometria[[1]] |> as.matrix()
  mean(ob[,2])
}

df <- deter_all |>  
  group_by(geometry) |> 
  mutate(
  ANO = year(VIEW_DATE),
  x = func_ret_x(geometry),
  y = func_ret_y(geometry)
) 
df |> 
  as_tibble() |> 
  # write_rds("../data-raw/deter-queimadas.rds")
```

### ðŸ’¨ Entrada com a Base: `deter-queimadas.rds`
```{r, eval=FALSE} 
# original archive "deter-queimadas.rds" = 122,1mb

deter_queimadas <- read_rds("data-raw/deter-queimadas.rds") |> 
  rename(
    longitude = x,
    latitude = y
  )

glimpse(deter_queimadas)
```


#### Classificando cada ponto em municÃ­pio
```{r, eval=FALSE}
library(sf)
library(dplyr)
library(lwgeom) # para st_make_valid

municipality_sf <- municipality %>%
  st_transform(crs = 4326) %>%
  st_make_valid()

deter_queimadas_sf <- st_as_sf(
  deter_queimadas,
  coords = c("longitude", "latitude"),
  crs = 4326,
  remove = FALSE # mantÃ©m as colunas originais lon/lat
)

deter_queimadas_sf <- st_join(
  deter_queimadas_sf,
  municipality_sf %>% select(name_muni),
  join = st_within
)

deter_queimadas_sf <- deter_queimadas_sf %>%
  mutate(city_ref = ifelse(is.na(name_muni), "Other", name_muni)) %>%
  select(-name_muni) # remove coluna original para evitra duplicada

deter_queimadas <- as.data.frame(deter_queimadas_sf)

glimpse(deter_queimadas)

# Salvar
write_rds(deter_queimadas, "data-raw/deter_queimadas.rds")
```

#### Classificando cada ponto em estado
```{r, eval=FALSE}
library(sf)
library(geobr)

# Transformar em objeto sf (coordenadas lon/lat, CRS WGS84), 
# Nesse caso os pontos jÃ¡ estÃ£o em lon/lat, EPSG:4326
deter_queimadas_sf <- st_as_sf(deter_queimadas, 
                    coords = c("longitude", "latitude"), 
                    crs = 4326,
                    remove = FALSE)

# Estados do geobr (CRS do pacote Ã© o SIRGAS 4674)
estados <- geobr::read_state(year = 2020) |> 
  st_transform(crs = 4326)   # transforma para mesmo sistema de referÃªncia de coord (WGS84)

# Join espacial
deter_queimadas <- st_join(deter_queimadas_sf, estados["abbrev_state"])

# Converter para data frame e renomear coluna 
deter_queimadas <- as_data_frame(deter_queimadas |> 
                               rename("state" = abbrev_state))

# Visualizar resumo
glimpse(deter_queimadas)
tail(deter_queimadas)

# Salvar
# write_rds(deter_queimadas, "../data/deter_queimadas.rds")
```










